<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cut Panel Inspection Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYGvVO1xCKRWpYeBgYeJcst91cFV9VbEw",
            authDomain: "cut-panel-inspection.firebaseapp.com",
            projectId: "cut-panel-inspection",
            storageBucket: "cut-panel-inspection.firebasestorage.app",
            messagingSenderId: "715452565109",
            appId: "1:715452565109:web:9b418d023a8f41d0239a3c",
            measurementId: "G-PVL6NKWQYH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, serverTimestamp
        };
    </script>

    <style>
        /* Modern Color Scheme & Variables - [Unchanged] */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #198754;
            --warning: #f8961e;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        header {
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 15px 30px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 50px; border-radius: 10px; }
        .logo-container h1 {
            font-size: 1.8rem; font-weight: 700;
            background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 0;
        }

        /* Navigation */
        nav ul { display: flex; list-style: none; gap: 10px; margin: 0; padding: 0; flex-wrap: wrap; }
        nav ul li button {
            background: transparent; border: 2px solid transparent; color: var(--dark);
            font-weight: 600; padding: 10px 18px; border-radius: var(--radius-sm);
            cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;
        }
        nav ul li button:hover { background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        nav ul li button.active { background: var(--primary); color: var(--white); box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }

        /* Main Content & Card Styles */
        main { flex: 1; padding: 30px 20px; display: flex; justify-content: center; align-items: flex-start; }
        .card {
            background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);
            overflow: hidden; width: 100%; max-width: 800px; transition: var(--transition);
        }
        .card:hover { box-shadow: var(--shadow-lg); }
        .card-header { background: var(--gradient); color: var(--white); padding: 20px 30px; }
        .card-header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 30px; }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .form-control {
            width: 100%; padding: 14px 16px; border: 1.5px solid var(--gray-light);
            border-radius: var(--radius-sm); font-size: 1rem; transition: var(--transition);
        }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }
        .form-control:disabled { background-color: var(--gray-light); cursor: not-allowed; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 24px; border: none; border-radius: var(--radius-sm);
            font-weight: 600; font-size: 1rem; cursor: pointer; transition: var(--transition);
        }
        .btn-primary { background: var(--gradient); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-secondary { background-color: var(--gray); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); } /* Added for Time Set button */
        .btn:disabled { background: var(--gray); cursor: not-allowed; transform: none; box-shadow: none; }

        /* Page Display Logic */
        .page { display: none; width: 100%; }
        .page.active { display: flex; justify-content: center; }

        /* --- NEW STYLES for Inspection --- */
        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; background: var(--light); padding: 20px; border-radius: var(--radius-sm); margin-bottom: 25px;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-item .label { font-size: 0.9rem; font-weight: 600; color: var(--gray); }
        .info-item .value { font-size: 1.1rem; font-weight: 700; color: var(--dark); }
        
        .defects-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
        }
        .defect-category {
            background: var(--light); padding: 20px; border-radius: var(--radius-sm); border: 1px solid var(--gray-light);
        }
        .defect-category h3 { margin-top: 0; margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;}
        .defect-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;
        }
        .checkbox-group {
            display: flex; align-items: center; gap: 8px;
            background: var(--white); padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--gray-light);
        }
        .checkbox-group input[type="number"] {
            width: 50px; border: none; background: transparent; text-align: center; font-weight: bold;
            padding: 5px; border-bottom: 2px solid var(--gray-light); transition: var(--transition);
        }
        .checkbox-group input[type="number"]:focus { outline: none; border-bottom-color: var(--primary); }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Report Page & Table Styles */
        .report-container { width: 100%; max-width: 98%; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); }
        .report-header { background: var(--gradient); color: var(--white); padding: 20px 30px; }
        .report-header h2 { margin: 0; font-size: 1.5rem; }
        .filter-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px; padding: 20px; background: var(--light); border-bottom: 1px solid var(--gray-light);
        }
        .filter-actions { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .table-container { overflow-x: auto; padding: 20px; }
        .report-table { width: 100%; border-collapse: collapse; min-width: 2000px; /* Adjust for more columns */ }
        .report-table th, .report-table td { padding: 12px 10px; border: 1px solid var(--gray-light); white-space: nowrap; text-align: left; }
        .report-table th { background: var(--primary); color: var(--white); position: sticky; top: 0; }
        .report-table tbody tr:hover { background: rgba(67, 97, 238, 0.05); }
        .report-table tfoot { font-weight: bold; background: var(--light); }
        .dhu-pass { color: var(--success); }
        .dhu-fail { color: var(--danger); font-weight: bold; }

        /* Loading Spinner & Toast */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: var(--dark); color: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 1001; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        
        /* Generic Modal Style */
        .modal {
            display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; 
            width: 90%; border-radius: var(--radius); box-shadow: var(--shadow-lg); 
            position: relative; animation: fadeIn 0.3s;
        }
        .close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* --- NEW: Edit Modal Specific Styles --- */
        #edit-entries-modal-content {
            max-width: 95%;
        }
        #edit-entries-table-container {
            max-height: 70vh;
            overflow: auto;
            margin-top: 20px;
        }
        #edit-entries-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        #edit-entries-table th, #edit-entries-table td {
            border: 1px solid var(--gray-light);
            padding: 8px;
            text-align: center;
        }
        #edit-entries-table th {
            background-color: var(--light);
            position: sticky;
            top: 0;
        }
        #edit-entries-table input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
        }
        #edit-entries-table .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* Print Styles */
        #print-header { display: none; }
        
        /* *** MODIFIED PRINT STYLES *** */
        @media print {
            @page { size: A3 landscape; margin: 0.5in; }

            /* Hide all UI elements and non-report pages by default */
            header, nav, .filter-section, .actions-cell, .btn, #balance-details-container, 
            #new-inspection-page, #entry-page, #top-defects-chart-container /* Hide chart on print */ { 
                display: none !important; 
            }
            
            /* Show the dedicated print header */
            #print-header { 
                display: block; 
                text-align: center; 
                margin-bottom: 20px; 
            }
            
            /* Reset layout for a printable document */
            body, main, .page, .report-container, .page.active {
                display: block !important; 
                width: 100% !important; 
                max-width: 100% !important; 
                box-shadow: none !important; 
                padding: 0 !important; 
                margin: 0 !important;
                background: #fff !important; 
                font-size: 8pt; 
            }
            
            /* Explicitly ensure the active report pages are visible */
            #admin-report-page, #summary-report-page {
                display: block !important;
            }

            /* Table styling for print */
            .table-container { 
                overflow: visible !important; 
                padding: 0 !important; 
            }
            .report-table { 
                font-size: 7pt; 
                width: 100%; 
                min-width: 0 !important; 
            }
            .report-table thead { display: table-header-group; }
            .report-table tfoot { display: table-footer-group; }
            .report-table tr { page-break-inside: avoid; }
            .report-table th, .report-table td { 
                padding: 4px; 
                border: 1px solid #999 !important; 
            }
            .report-table th { 
                background-color: #E0E0E0 !important; 
                color: #000 !important; 
                -webkit-print-color-adjust: exact; 
                color-adjust: exact; 
            }
        }
        
        /* *** NEW CHART STYLES ADDED AS REQUESTED *** */
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .chart-label {
            width: 200px; /* Fixed width for alignment */
            padding-right: 10px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 600;
        }
        .chart-progress-container {
            flex-grow: 1;
            background-color: var(--gray-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        .chart-progress-bar {
            height: 25px;
            background: var(--gradient);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-sizing: border-box;
            transition: width 0.5s ease-in-out;
        }
        /* *** END OF NEW CHART STYLES *** */

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .defects-container { grid-template-columns: 1fr; }
            .filter-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.postimg.cc/pX0b4dM3/20251017-203816.png" alt="Logo">
            <h1>Cut Panel Inspection</h1>
        </div>
        <nav>
             <!-- Timer Display -->
            <div id="timer-display" style="font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 15px; flex-wrap: wrap;"></div>
            <ul>
                <li><button id="nav-new-inspection" class="active"><i class="fas fa-plus-circle"></i> New Inspection</button></li>
                <li><button id="nav-admin-report"><i class="fas fa-list-alt"></i> Admin Reports</button></li>
                <li><button id="nav-summary-report"><i class="fas fa-chart-line"></i> Hourly Summary</button></li>
                 <li><button id="nav-edit-mode"><i class="fas fa-edit"></i> Enable Edit</button></li>
            </ul>
        </nav>
    </header>

    <div id="print-header">
        <h2>FAKHRUDDIN TEXTILE MILLS LTD.</h2>
        <h3>Kewa, Sreepur, Gazipur.</h3>
        <h4>Cut Panel Inspection Report</h4>
    </div>

    <main>
        <!-- Page 1: Start New Inspection -->
        <section id="new-inspection-page" class="page active">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-play-circle"></i> Start a New Inspection</h2></div>
                <div class="card-body">
                    <form id="start-inspection-form">
                        <div class="form-group">
                            <label for="inspector-name" class="form-label"><i class="fas fa-user"></i> Inspector Name</label>
                            <input type="text" id="inspector-name" class="form-control" placeholder="Enter your name" required>
                        </div>
                        <div class="form-group">
                            <label for="select-cutting" class="form-label"><i class="fas fa-search"></i> Select Cutting Plan</label>
                            
                            <!-- New filter inputs -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <input type="text" id="filter-style-popup" class="form-control" placeholder="Filter by Style...">
                                <input type="text" id="filter-cutting-popup" class="form-control" placeholder="Filter by Cutting No...">
                            </div>
                            
                            <select id="select-cutting" class="form-control" required>
                                <option value="">Loading cutting plans...</option>
                            </select>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Total Plan Qty</span>
                                <span class="value" id="info-total-qty">0</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Already Checked</span>
                                <span class="value" id="info-checked-qty">0</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Remaining Qty</span>
                                <span class="value" id="info-remaining-qty">0</span>
                            </div>
                        </div>

                        <!-- *** NEW ELEMENT ADDED AS REQUESTED *** -->
                        <div id="balance-details-container" style="margin-top: 20px; padding: 15px; background: var(--gray-light); border: 1px solid #ddd; border-radius: var(--radius-sm); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="font-weight: 600;">
                                <span class="label">Total Balance to Check: </span>
                                <span class="value" id="total-balance-qty" style="color: var(--danger);">0 Pcs</span>
                            </div>
                            <button type="button" id="show-balance-details-btn" class="btn btn-secondary" style="padding: 8px 16px;">Details</button>
                        </div>
                        <!-- *** END OF NEW ELEMENT *** -->

                        <button type="submit" id="start-inspection-btn" class="btn btn-primary" style="margin-top: 25px;"><i class="fas fa-arrow-right"></i> Start Inspection</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Page 2: Inspection Data Entry -->
        <section id="entry-page" class="page">
            <div class="card" style="max-width: 1200px;">
                <div class="card-header"><h2><i class="fas fa-tasks"></i> Hourly Inspection Entry</h2></div>
                <div class="card-body">
                    <div class="info-grid" id="entry-info-header">
                        <!-- Info will be populated by JS -->
                    </div>
                    <form id="inspection-entry-form">
                        <div class="form-group">
                            <label for="checked-qty" class="form-label"><i class="fas fa-check-double"></i> Quantity Checked This Hour</label>
                            <input type="number" id="checked-qty" class="form-control" placeholder="Enter quantity" required min="1">
                        </div>
                        
                        <div class="defects-container">
                            <div id="reject-category" class="defect-category">
                                <h3><i class="fas fa-times-circle"></i> Reject Defects</h3>
                                <div id="reject-defects-list" class="defect-grid"></div>
                            </div>
                            <div id="defect-category" class="defect-category">
                                <h3><i class="fas fa-exclamation-triangle"></i> Cutting Defects</h3>
                                <div id="cutting-defects-list" class="defect-grid"></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" id="save-entry-btn" class="btn btn-success"><i class="fas fa-save"></i> Save Hour Entry</button>
                            <button type="button" id="back-to-start-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Selection</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- Page 3: Admin Reports -->
        <section id="admin-report-page" class="page">
            <div class="report-container">
                <div class="report-header"><h2><i class="fas fa-shield-alt"></i> Admin Inspection Reports</h2></div>
                <div class="filter-section">
                    <input type="date" id="filter-date-from" class="form-control" title="Date From">
                    <input type="date" id="filter-date-to" class="form-control" title="Date To">
                    <input type="text" id="filter-inspector" class="form-control" placeholder="Filter by Inspector">
                    <select id="filter-buyer" class="form-control"><option value="">All Buyers</option></select>
                    <input type="text" id="filter-style" class="form-control" placeholder="Filter by Style">
                    <input type="text" id="filter-color" class="form-control" placeholder="Filter by Color">
                    <input type="text" id="filter-lot" class="form-control" placeholder="Filter by Lot No">
                    <input type="text" id="filter-cutting" class="form-control" placeholder="Filter by Cutting No">
                    <div class="filter-actions">
                        <button id="apply-filter-btn" class="btn btn-primary"><i class="fas fa-filter"></i> Apply</button>
                        <button id="print-report-btn" class="btn btn-secondary"><i class="fas fa-print"></i> Print</button>
                        <button id="download-excel-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> Download Excel</button>
                        <!-- MODIFIED BUTTON ID -->
                        <button id="timer-control-btn" class="btn btn-warning"><i class="fas fa-clock"></i> Time Set</button>
                    </div>
                </div>
                
                <!-- *** NEW CHART ADDED AS REQUESTED *** -->
                <div id="top-defects-chart-container" class="card-body" style="display: none; background: #fdfdff; border-bottom: 1px solid var(--gray-light);">
                    <h3 style="text-align: center; margin-bottom: 25px; color: var(--primary); font-size: 1.3rem;">
                        <i class="fas fa-chart-bar"></i> Top 10 Cutting Defects Analysis
                    </h3>
                    <div id="top-defects-chart">
                        <!-- Chart bars will be injected here by JS -->
                    </div>
                </div>
                <!-- *** END OF NEW CHART *** -->

                <div class="table-container">
                    <table id="report-table" class="report-table">
                        <thead id="report-head"></thead>
                        <tbody id="report-body"></tbody>
                        <tfoot id="report-foot"></tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Page 4: Hourly Summary Report -->
        <section id="summary-report-page" class="page">
            <div class="report-container" style="max-width: 1400px;">
                <div class="report-header"><h2><i class="fas fa-clock"></i> Hourly Summary Report</h2></div>
                <!-- *** NEW FILTER SECTION ADDED AS REQUESTED *** -->
                <div class="filter-section">
                    <input type="date" id="summary-filter-date-from" class="form-control" title="Date From">
                    <input type="date" id="summary-filter-date-to" class="form-control" title="Date To">
                    <input type="text" id="summary-filter-inspector" class="form-control" placeholder="Filter by Inspector">
                    <select id="summary-filter-buyer" class="form-control"><option value="">All Buyers</option></select>
                    <input type="text" id="summary-filter-style" class="form-control" placeholder="Filter by Style">
                    <input type="text" id="summary-filter-cut-no" class="form-control" placeholder="Filter by Cut No">
                    <div class="filter-actions">
                        <button id="summary-apply-filter-btn" class="btn btn-primary"><i class="fas fa-filter"></i> Apply</button>
                        <button id="summary-print-report-btn" class="btn btn-secondary"><i class="fas fa-print"></i> Print</button>
                        <button id="summary-download-excel-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> Download Excel</button>
                    </div>
                </div>
                 <div class="table-container">
                    <table id="summary-table" class="report-table" style="min-width: 1200px;">
                        <thead id="summary-head"></thead>
                        <tbody id="summary-body"></tbody>
                        <tfoot id="summary-foot"></tfoot>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="toast"></div>

    <!-- *** NEW MODAL ADDED AS REQUESTED *** -->
    <div id="balance-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span id="close-modal-btn" class="close-btn">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--primary);">Remaining Styles to Check</h2>
            <div id="modal-body-content" style="max-height: 60vh; overflow-y: auto;">
                <!-- Details will be populated here by JS -->
            </div>
        </div>
    </div>
    <!-- *** END OF NEW MODAL *** -->

    <!-- *** NEW EDIT MODAL ADDED FOR THE REQUEST *** -->
    <div id="edit-entries-modal" class="modal">
        <div class="modal-content" id="edit-entries-modal-content">
            <span id="close-edit-modal-btn" class="close-btn">&times;</span>
            <h2 style="margin-bottom: 10px; color: var(--primary);">Edit Inspection Entries</h2>
            <div id="edit-modal-header-info"></div>
            <div id="edit-entries-table-container">
                <table id="edit-entries-table">
                    <thead id="edit-entries-table-head"></thead>
                    <tbody id="edit-entries-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- *** END OF NEW EDIT MODAL *** -->


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONSTANTS ---
        const CUTTING_COLLECTION = "cutting reports";
        const INSPECTION_COLLECTION = "inspection entries";
        const REJECT_CATEGORIES = ["Fabric Hole", "Patta", "Yarn Missing", "Slub", "Crease Mark", "Dyeing Spot", "Loop Out", "Shade", "Knot", "GSM Cut", "Joint", "Line Mark", "Conta", "Twisting", "AOP Problem", "Other's"];
        const DEFECT_CATEGORIES = ["Sticker Spot", "Up-down", "Over Lay", "Print/Style Mistake", "Way Mistake", "Uneven Shape", "Cutting Shade", "Notch Mark", "Dirty Spot", "Edge Cut", "Bundle/Size Mistake"];
        const ALL_DEFECTS = [...REJECT_CATEGORIES, ...DEFECT_CATEGORIES];

        // --- STATE MANAGEMENT ---
        let allCuttingReports = [];
        let allInspectionEntries = [];
        let currentInspection = {};
        let editModeEnabled = false;
        
        // --- MODIFIED TIMER STATE ---
        let inspectionStartTime = null; // Holds the start time set by the admin
        let plannedWorkHours = null; // Holds the total planned work hours
        let timerInterval = null; // Holds the interval for the timer display

        // --- PAGE ELEMENTS ---
        const pages = {
            newInspection: document.getElementById('new-inspection-page'),
            entry: document.getElementById('entry-page'),
            adminReport: document.getElementById('admin-report-page'),
            summaryReport: document.getElementById('summary-report-page')
        };
        const navButtons = {
            newInspection: document.getElementById('nav-new-inspection'),
            adminReport: document.getElementById('nav-admin-report'),
            summaryReport: document.getElementById('nav-summary-report'),
            editMode: document.getElementById('nav-edit-mode')
        };
        const allNavLinks = document.querySelectorAll('nav ul li button');
        const toast = document.getElementById('toast');
        const timerDisplay = document.getElementById('timer-display');
        const timerControlButton = document.getElementById('timer-control-btn');
        const saveEntryBtn = document.getElementById('save-entry-btn');


        // --- FIREBASE HELPER FUNCTIONS ---
        async function fetchData(collectionName, orderByField = "date", orderByDirection = "desc") {
            try {
                const { collection, query, orderBy, getDocs } = window.firebaseFunctions;
                const db = window.firebaseDb;

                const q = query(collection(db, collectionName), orderBy(orderByField, orderByDirection));
                const querySnapshot = await getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error(`Error loading ${collectionName}: `, error);
                showToast(`Error loading ${collectionName}. Check console for details (F12). It might be a missing Firestore index.`, 'error');
                return [];
            }
        }

        async function saveData(collectionName, data) {
            try {
                const { collection, addDoc, serverTimestamp } = window.firebaseFunctions;
                const db = window.firebaseDb;

                data.createdAt = serverTimestamp();
                const docRef = await addDoc(collection(db, collectionName), data);
                return { id: docRef.id, ...data };
            } catch (error) {
                console.error(`Error saving to ${collectionName}: `, error);
                showToast('Error saving data!', 'error');
                throw error;
            }
        }
        
        async function updateData(collectionName, id, data) {
            try {
                const { doc, updateDoc } = window.firebaseFunctions;
                const db = window.firebaseDb;
                await updateDoc(doc(db, collectionName, id), data);
                return true;
            } catch (error) {
                console.error("Error updating document: ", error);
                throw error;
            }
        }
        
        async function deleteData(collectionName, id) {
             try {
                const { doc, deleteDoc } = window.firebaseFunctions;
                const db = window.firebaseDb;
                await deleteDoc(doc(db, collectionName, id));
                return true;
            } catch (error) {
                console.error("Error deleting document: ", error);
                throw error;
            }
        }

        // --- UI HELPER FUNCTIONS ---
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        function showPage(pageId) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            if (pages[pageId]) pages[pageId].classList.add('active');
        }

        function setActiveNav(button) {
            allNavLinks.forEach(link => link.classList.remove('active'));
            button.classList.add('active');
        }
        
        function showLoadingButton(btn, text = 'Saving...') {
            btn.disabled = true;
            btn.innerHTML = `<div class="loading"></div> ${text}`;
        }

        function hideLoadingButton(btn, originalHtml) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }

        // --- INITIALIZATION ---
        async function initialize() {
            showPage('newInspection');
            setActiveNav(navButtons.newInspection);
            
            allCuttingReports = await fetchData(CUTTING_COLLECTION, "date", "desc");
            allInspectionEntries = await fetchData(INSPECTION_COLLECTION, "createdAt", "desc");

            populateCuttingSelector();
            populateBuyerFilter();
            generateDefectCheckboxes();
            updateTotalBalanceDisplay();
        }

        // --- PAGE 1: NEW INSPECTION SETUP ---
        const filterStylePopup = document.getElementById('filter-style-popup');
        const filterCuttingPopup = document.getElementById('filter-cutting-popup');

        function populateCuttingSelector() {
            const selector = document.getElementById('select-cutting');
            const styleFilter = filterStylePopup.value.toLowerCase();
            const cuttingFilter = filterCuttingPopup.value.toLowerCase();

            const filteredReports = allCuttingReports.filter(report => {
                const styleMatch = report.style ? report.style.toLowerCase().includes(styleFilter) : true;
                const cuttingMatch = report.cuttingNo ? report.cuttingNo.toLowerCase().includes(cuttingFilter) : true;
                return styleMatch && cuttingMatch;
            });
            
            const previouslySelectedValue = selector.value;
            selector.innerHTML = '<option value="">Select a Cutting Plan</option>';

            filteredReports.forEach(report => {
                const option = document.createElement('option');
                option.value = report.id;
                option.textContent = `Lot: ${report.lotNo} | Cut: ${report.cuttingNo} | Style: ${report.style} | Color: ${report.color}`;
                selector.appendChild(option);
            });
            
            if (filteredReports.some(report => report.id === previouslySelectedValue)) {
                selector.value = previouslySelectedValue;
            } else {
                selector.value = "";
                if (document.getElementById('new-inspection-page').classList.contains('active')) {
                     updateInfoDisplays(0, 0, 0);
                     document.getElementById('start-inspection-btn').disabled = true;
                }
            }
        }

        filterStylePopup.addEventListener('input', populateCuttingSelector);
        filterCuttingPopup.addEventListener('input', populateCuttingSelector);
        
        function populateBuyerFilter() {
            const buyers = [...new Set(allCuttingReports.map(r => r.buyer))].filter(Boolean).sort();
            const selectors = [document.getElementById('filter-buyer'), document.getElementById('summary-filter-buyer')];
            
            selectors.forEach(selector => {
                if(selector) {
                    selector.innerHTML = '<option value="">All Buyers</option>';
                    buyers.forEach(buyer => {
                        const option = document.createElement('option');
                        option.value = buyer;
                        option.textContent = buyer;
                        selector.appendChild(option);
                    });
                }
            });
        }

        document.getElementById('select-cutting').addEventListener('change', async (e) => {
            const cuttingId = e.target.value;
            if (!cuttingId) {
                updateInfoDisplays(0, 0, 0);
                return;
            }

            const selectedCutting = allCuttingReports.find(r => r.id === cuttingId);
            const relatedInspections = allInspectionEntries.filter(i => i.cuttingReportId === cuttingId);
            
            const totalQty = selectedCutting.totalPieces || 0;
            const checkedQty = relatedInspections.reduce((sum, entry) => sum + (parseInt(entry.checkedQty) || 0), 0);
            const remainingQty = totalQty - checkedQty;

            updateInfoDisplays(totalQty, checkedQty, remainingQty);
            
            document.getElementById('start-inspection-btn').disabled = remainingQty <= 0;
        });

        function updateInfoDisplays(total, checked, remaining) {
            document.getElementById('info-total-qty').textContent = total;
            document.getElementById('info-checked-qty').textContent = checked;
            const remainingQtyElem = document.getElementById('info-remaining-qty');
            remainingQtyElem.textContent = remaining < 0 ? 0 : remaining;
            remainingQtyElem.style.color = remaining <= 0 ? 'var(--danger)' : 'var(--dark)';
        }

        document.getElementById('start-inspection-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const inspectorName = document.getElementById('inspector-name').value.trim();
            const cuttingId = document.getElementById('select-cutting').value;
            
            if (!inspectorName || !cuttingId) {
                showToast('Please enter your name and select a cutting plan.', 'error');
                return;
            }

            if (!inspectionStartTime) {
                showToast('Admin must set the inspection start time first from the Admin Report page.', 'error');
                return;
            }
            
            const selectedCutting = allCuttingReports.find(r => r.id === cuttingId);
            const remainingQty = parseInt(document.getElementById('info-remaining-qty').textContent);
            
            currentInspection = {
                inspectorName,
                cuttingReportId: cuttingId,
                selectedCutting,
                remainingQty
            };
            
            setupEntryPage();
            showPage('entry');
        });

        // --- PAGE 2: INSPECTION ENTRY ---
        function generateDefectCheckboxes() {
            const rejectContainer = document.getElementById('reject-defects-list');
            const defectContainer = document.getElementById('cutting-defects-list');
            
            rejectContainer.innerHTML = '';
            defectContainer.innerHTML = '';

            REJECT_CATEGORIES.forEach(name => {
                const id = `reject-${name.replace(/[^a-zA-Z0-9]/g, '')}`;
                rejectContainer.innerHTML += `
                    <div class="checkbox-group">
                        <input type="number" min="0" value="0" data-defect-name="${name}" id="${id}">
                        <label for="${id}">${name}</label>
                    </div>`;
            });

            DEFECT_CATEGORIES.forEach(name => {
                const id = `defect-${name.replace(/[^a-zA-Z0-9]/g, '')}`;
                defectContainer.innerHTML += `
                    <div class="checkbox-group">
                        <input type="number" min="0" value="0" data-defect-name="${name}" id="${id}">
                        <label for="${id}">${name}</label>
                    </div>`;
            });
        }

        function setupEntryPage() {
            const header = document.getElementById('entry-info-header');
            const { inspectorName, selectedCutting, remainingQty } = currentInspection;
            header.innerHTML = `
                <div class="info-item"><span class="label">Inspector</span><span class="value">${inspectorName}</span></div>
                <div class="info-item"><span class="label">Style</span><span class="value">${selectedCutting.style}</span></div>
                <div class="info-item"><span class="label">Color</span><span class="value">${selectedCutting.color}</span></div>
                <div class="info-item"><span class="label">Lot/Cut No</span><span class="value">${selectedCutting.lotNo} / ${selectedCutting.cuttingNo}</span></div>
                <div class="info-item"><span class="label">Remaining Qty</span><span class="value" style="color: var(--danger);">${remainingQty}</span></div>
            `;
            document.getElementById('inspection-entry-form').reset();
            document.getElementById('checked-qty').focus();
        }

        document.getElementById('inspection-entry-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!inspectionStartTime) {
                showToast('Cannot save. Admin has not set the inspection start time.', 'error');
                return;
            }

            const btn = document.getElementById('save-entry-btn');
            const originalHtml = btn.innerHTML;
            
            const checkedQty = parseInt(document.getElementById('checked-qty').value);
            if (isNaN(checkedQty) || checkedQty <= 0) {
                showToast('Please enter a valid checked quantity.', 'error');
                return;
            }

            if (checkedQty > currentInspection.remainingQty) {
                showToast(`Checked quantity (${checkedQty}) cannot exceed remaining quantity (${currentInspection.remainingQty}).`, 'error');
                return;
            }
            
            showLoadingButton(btn);
            
            // Calculate which hour slot this entry belongs to
            const now = new Date();
            const diffInMillis = now - inspectionStartTime;
            const currentHour = Math.floor(diffInMillis / (1000 * 60 * 60)) + 1;

            const entryData = {
                inspectorName: currentInspection.inspectorName,
                cuttingReportId: currentInspection.cuttingReportId,
                checkedQty,
                date: new Date().toISOString().split('T')[0],
                inspectionHour: currentHour, // Store the calculated hour
                defects: {}
            };

            document.querySelectorAll('#reject-defects-list input, #cutting-defects-list input').forEach(input => {
                const count = parseInt(input.value) || 0;
                if (count > 0) {
                    entryData.defects[input.dataset.defectName] = count;
                }
            });

            try {
                const savedEntry = await saveData(INSPECTION_COLLECTION, entryData);
                allInspectionEntries.unshift(savedEntry);
                
                currentInspection.remainingQty -= checkedQty;
                
                showToast('Hourly entry saved successfully!');
                updateTotalBalanceDisplay();
                
                if (currentInspection.remainingQty <= 0) {
                    alert('Inspection for this cutting is complete!');
                    document.getElementById('back-to-start-btn').click();
                } else {
                    setupEntryPage();
                }
            } finally {
                hideLoadingButton(btn, originalHtml);
            }
        });
        
        document.getElementById('back-to-start-btn').addEventListener('click', () => {
             document.getElementById('start-inspection-form').reset();
             updateInfoDisplays(0, 0, 0);
             populateCuttingSelector();
             showPage('newInspection');
        });

        // --- BALANCE DETAILS LOGIC ---
        const totalBalanceQtyEl = document.getElementById('total-balance-qty');
        const showBalanceDetailsBtn = document.getElementById('show-balance-details-btn');
        const balanceModal = document.getElementById('balance-details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalBodyContent = document.getElementById('modal-body-content');

        function getIncompleteStylesDetails() {
            const inspectionTotals = {};
            allInspectionEntries.forEach(entry => {
                const id = entry.cuttingReportId;
                inspectionTotals[id] = (inspectionTotals[id] || 0) + (entry.checkedQty || 0);
            });

            const incompleteStyles = [];
            let totalRemaining = 0;

            allCuttingReports.forEach(report => {
                const checkedQty = inspectionTotals[report.id] || 0;
                const remaining = (report.totalPieces || 0) - checkedQty;
                if (remaining > 0) {
                    incompleteStyles.push({ ...report, remainingQty: remaining });
                    totalRemaining += remaining;
                }
            });

            return { incompleteStyles, totalRemaining };
        }

        function updateTotalBalanceDisplay() {
            if(!totalBalanceQtyEl) return;
            const { totalRemaining } = getIncompleteStylesDetails();
            totalBalanceQtyEl.textContent = `${totalRemaining} Pcs`;
        }

        function showBalanceDetailsModal() {
            const { incompleteStyles } = getIncompleteStylesDetails();
            
            if (incompleteStyles.length === 0) {
                modalBodyContent.innerHTML = '<p style="text-align: center; padding: 20px;">All cutting plans are fully checked. No remaining styles.</p>';
            } else {
                let tableHtml = `
                    <table class="report-table" style="min-width: 100%; font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th>Style</th>
                                <th>Color</th>
                                <th>Lot No</th>
                                <th>Cut No</th>
                                <th>Remaining Pcs</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                incompleteStyles.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(style => {
                    tableHtml += `
                        <tr>
                            <td>${style.style || ''}</td>
                            <td>${style.color || ''}</td>
                            <td>${style.lotNo || ''}</td>
                            <td>${style.cuttingNo || ''}</td>
                            <td style="font-weight: bold; color: var(--danger); text-align: center;">${style.remainingQty}</td>
                        </tr>
                    `;
                });
                tableHtml += '</tbody></table>';
                modalBodyContent.innerHTML = tableHtml;
            }

            balanceModal.style.display = 'flex';
        }

        showBalanceDetailsBtn.addEventListener('click', showBalanceDetailsModal);
        closeModalBtn.addEventListener('click', () => { balanceModal.style.display = 'none'; });
        balanceModal.addEventListener('click', (e) => {
            if (e.target === balanceModal) {
                balanceModal.style.display = 'none';
            }
        });
        
        // --- *** NEW & IMPROVED TIMER LOGIC *** ---

        function updateTimerDisplay() {
            if (!inspectionStartTime) {
                timerDisplay.innerHTML = '';
                return;
            }

            const now = new Date();
            const diffInMillis = now - inspectionStartTime;

            // Calculate Elapsed Time
            const elapsedHours = Math.floor(diffInMillis / 3600000);
            const elapsedMinutes = Math.floor((diffInMillis % 3600000) / 60000);
            const elapsedSeconds = Math.floor((diffInMillis % 60000) / 1000);
            const formattedElapsed = `${String(elapsedHours).padStart(2, '0')}:${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;

            // Calculate Remaining Time
            let formattedRemaining = 'N/A';
            let remainingColor = 'var(--dark)';
            if (plannedWorkHours) {
                const plannedMillis = plannedWorkHours * 3600 * 1000;
                let remainingMillis = plannedMillis - diffInMillis;
                
                if (remainingMillis < 0) {
                    remainingColor = 'var(--danger)';
                    remainingMillis = Math.abs(remainingMillis); // Make it positive for display
                }

                const remainingHours = Math.floor(remainingMillis / 3600000);
                const remainingMinutes = Math.floor((remainingMillis % 3600000) / 60000);
                const remainingSeconds = Math.floor((remainingMillis % 60000) / 1000);
                formattedRemaining = `${String(remainingHours).padStart(2, '0')}:${String(remainingMinutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                
                if (plannedMillis < diffInMillis) {
                    formattedRemaining = `-${formattedRemaining} (Overtime)`;
                }
            }

            const startHours = String(inspectionStartTime.getHours()).padStart(2, '0');
            const startMinutes = String(inspectionStartTime.getMinutes()).padStart(2, '0');

            let statusIcon = timerInterval
                ? '<i class="fas fa-play-circle" style="color:var(--success);"></i>'
                : '<i class="fas fa-pause-circle" style="color:var(--warning);"></i>';

            timerDisplay.innerHTML = `
                <span title="Workday Start Time">${statusIcon} Start: <strong>${startHours}:${startMinutes}</strong></span>
                <span title="Total Time Elapsed Since Start"><i class="fas fa-hourglass-half"></i> Elapsed: <strong>${formattedElapsed}</strong></span>
                <span title="Total Planned Work Duration"><i class="fas fa-tasks"></i> Plan: <strong>${plannedWorkHours ? plannedWorkHours.toFixed(1) + ' hrs' : 'N/A'}</strong></span>
                <span title="Time Remaining / Overtime" style="font-weight: bold; color: ${remainingColor};"><i class="fas fa-flag-checkered"></i> Remaining: <strong>${formattedRemaining}</strong></span>
            `;
        }

        function startTimer(toastMessage) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();
            showToast(toastMessage, "success");
            saveEntryBtn.disabled = false;
            
            timerControlButton.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Timer';
            timerControlButton.classList.remove('btn-warning', 'btn-success');
            timerControlButton.classList.add('btn-danger');
        }

        function stopTimer(toastMessage) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            updateTimerDisplay();
            showToast(toastMessage, "warning");
            saveEntryBtn.disabled = true;

            timerControlButton.innerHTML = '<i class="fas fa-play-circle"></i> Resume / Extend';
            timerControlButton.classList.remove('btn-warning', 'btn-danger');
            timerControlButton.classList.add('btn-success');
        }

        timerControlButton.addEventListener('click', () => {
            // Case 1: Timer has never been started
            if (!inspectionStartTime) {
                const planInput = prompt("Enter total planned work hours for today (e.g., 8):");
                if (!planInput || isNaN(parseFloat(planInput)) || parseFloat(planInput) <= 0) {
                    showToast("Invalid planned hours. Please enter a positive number.", "error");
                    return;
                }
                plannedWorkHours = parseFloat(planInput);

                if (confirm("Start the inspection timer from the current time?")) {
                    inspectionStartTime = new Date();
                    startTimer('Inspection timer started from current time!');
                } else {
                    const timeInput = prompt("Enter the start time (e.g., 08:00):", "08:00");
                    if (timeInput && /^\d{2}:\d{2}$/.test(timeInput)) {
                        const [hours, minutes] = timeInput.split(':');
                        const today = new Date();
                        inspectionStartTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0);
                        startTimer(`Inspection timer started at ${timeInput}`);
                    } else if (timeInput) {
                        showToast("Invalid time format. Please use HH:MM.", "error");
                        plannedWorkHours = null; // Reset if start fails
                    } else {
                        plannedWorkHours = null; // User cancelled start time prompt
                    }
                }
            }
            // Case 2: Timer is currently running
            else if (timerInterval) {
                if (confirm("Are you sure you want to stop the timer? This will prevent new entries from being saved.")) {
                    stopTimer('Timer stopped.');
                }
            }
            // Case 3: Timer is stopped but was started before
            else {
                if (confirm("Press OK to RESUME the timer.\nPress Cancel to EXTEND the planned time.")) {
                    startTimer('Timer resumed.');
                } else {
                    const extendInput = prompt("Enter additional hours to extend the plan (e.g., 1 or 1.5):");
                    const additionalHours = parseFloat(extendInput);
                    if (extendInput && !isNaN(additionalHours) && additionalHours > 0) {
                        plannedWorkHours += additionalHours;
                        startTimer(`${additionalHours} hours added to the plan. Timer resumed.`);
                    } else if (extendInput) {
                        showToast("Invalid input for extension.", "error");
                    }
                }
            }
        });

        // --- PAGE 3: ADMIN REPORT ---
        function prepareAdminReportData() {
            const combinedData = [];

            allCuttingReports.forEach(cutting => {
                const relatedInspections = allInspectionEntries.filter(insp => insp.cuttingReportId === cutting.id);
                
                const dataRow = { ...cutting, inspections: relatedInspections };
                
                dataRow.totalChecked = relatedInspections.reduce((sum, i) => sum + (i.checkedQty || 0), 0);
                dataRow.inspectors = [...new Set(relatedInspections.map(i => i.inspectorName))].join(', ');

                dataRow.rejectTotals = {};
                REJECT_CATEGORIES.forEach(cat => dataRow.rejectTotals[cat] = 0);
                dataRow.defectTotals = {};
                DEFECT_CATEGORIES.forEach(cat => dataRow.defectTotals[cat] = 0);

                relatedInspections.forEach(insp => {
                    for (const [defectName, count] of Object.entries(insp.defects || {})) {
                        if (REJECT_CATEGORIES.includes(defectName)) {
                            dataRow.rejectTotals[defectName] = (dataRow.rejectTotals[defectName] || 0) + count;
                        } else if (DEFECT_CATEGORIES.includes(defectName)) {
                            dataRow.defectTotals[defectName] = (dataRow.defectTotals[defectName] || 0) + count;
                        }
                    }
                });

                dataRow.totalReject = Object.values(dataRow.rejectTotals).reduce((sum, val) => sum + val, 0);
                dataRow.totalDefect = Object.values(dataRow.defectTotals).reduce((sum, val) => sum + val, 0);
                
                if (dataRow.totalChecked > 0) {
                    dataRow.fabricDHU = ((dataRow.totalReject / dataRow.totalChecked) * 100).toFixed(2);
                    dataRow.cuttingDHU = ((dataRow.totalDefect / dataRow.totalChecked) * 100).toFixed(2);
                    dataRow.totalDHU = (((dataRow.totalReject + dataRow.totalDefect) / dataRow.totalChecked) * 100).toFixed(2);
                } else {
                    dataRow.fabricDHU = dataRow.cuttingDHU = dataRow.totalDHU = '0.00';
                }
                combinedData.push(dataRow);
            });
            return combinedData.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        document.getElementById('apply-filter-btn').addEventListener('click', () => {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const inspector = document.getElementById('filter-inspector').value.toLowerCase();
            const buyer = document.getElementById('filter-buyer').value;
            const style = document.getElementById('filter-style').value.toLowerCase();
            const color = document.getElementById('filter-color').value.toLowerCase();
            const lot = document.getElementById('filter-lot').value.toLowerCase();
            const cutting = document.getElementById('filter-cutting').value.toLowerCase();
            
            const allData = prepareAdminReportData();
            const dataWithChecks = allData.filter(row => row.totalChecked > 0);

            const filteredData = dataWithChecks.filter(row => {
                 const reportDate = new Date(row.date);
                 const fromDate = dateFrom ? new Date(dateFrom) : null;
                 const toDate = dateTo ? new Date(dateTo) : null;
                 if (toDate) toDate.setHours(23, 59, 59, 999);

                 return (!fromDate || reportDate >= fromDate) &&
                        (!toDate || reportDate <= toDate) &&
                        (!inspector || (row.inspectors && row.inspectors.toLowerCase().includes(inspector))) &&
                        (!buyer || row.buyer === buyer) &&
                        (!style || (row.style && row.style.toLowerCase().includes(style))) &&
                        (!color || (row.color && row.color.toLowerCase().includes(color))) &&
                        (!lot || (row.lotNo && row.lotNo.toLowerCase().includes(lot))) &&
                        (!cutting || (row.cuttingNo && row.cuttingNo.toLowerCase().includes(cutting)));
            });

            renderAdminReportTable(filteredData);
        });

        // *** NEW CHART FUNCTION ADDED AS REQUESTED ***
        function renderTopDefectsChart(data) {
            const chartContainer = document.getElementById('top-defects-chart-container');
            const chart = document.getElementById('top-defects-chart');

            const defectCounts = {};
            let totalDefects = 0;

            // Sum up all cutting defects from the filtered data
            data.forEach(row => {
                for (const [defectName, count] of Object.entries(row.defectTotals)) {
                    defectCounts[defectName] = (defectCounts[defectName] || 0) + count;
                    totalDefects += count;
                }
            });

            if (totalDefects === 0) {
                chartContainer.style.display = 'none';
                return;
            }

            // Convert to array, calculate percentage, sort, and get top 10
            const sortedDefects = Object.entries(defectCounts)
                .map(([name, count]) => ({
                    name,
                    count,
                    percentage: ((count / totalDefects) * 100).toFixed(2)
                }))
                .filter(d => d.count > 0) // Only include defects with count > 0
                .sort((a, b) => b.count - a.count) // Sort by count descending
                .slice(0, 10); // Get the top 10

            chart.innerHTML = ''; // Clear previous chart

            if (sortedDefects.length === 0) {
                 chartContainer.style.display = 'none';
                 return;
            }
            
            sortedDefects.forEach(defect => {
                const barHtml = `
                    <div class="chart-bar">
                        <div class="chart-label" title="${defect.name}">${defect.name}</div>
                        <div class="chart-progress-container">
                            <div class="chart-progress-bar" style="width: ${defect.percentage}%;">
                                ${defect.percentage}% (${defect.count})
                            </div>
                        </div>
                    </div>
                `;
                chart.innerHTML += barHtml;
            });

            chartContainer.style.display = 'block';
        }
        // *** END OF NEW CHART FUNCTION ***

        function renderAdminReportTable(data) {
            const head = document.getElementById('report-head');
            const body = document.getElementById('report-body');
            const foot = document.getElementById('report-foot');
            
            head.innerHTML = ''; body.innerHTML = ''; foot.innerHTML = '';

            // *** NEW: Call the chart rendering function here ***
            renderTopDefectsChart(data);

            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="100" style="text-align: center;">No reports found for the selected filters.</td></tr>';
                return;
            }
            
            const baseHeaders = ['Date', 'Inspector(s)', 'Buyer', 'Style', 'Color', 'Lot No', 'Cut No', 'Total Plan', 'Total Checked'];
            const rejectHeaders = REJECT_CATEGORIES.map(c => `R: ${c}`);
            const defectHeaders = DEFECT_CATEGORIES.map(c => `D: ${c}`);
            const totalHeaders = ['Total Reject', 'Total Defect', 'Total R+D', 'Fabric DHU%', 'Cutting DHU%', 'Total DHU%'];
            
            head.innerHTML = `<tr>
                ${[...baseHeaders, ...rejectHeaders, ...defectHeaders, ...totalHeaders].map(h => `<th>${h}</th>`).join('')}
                 ${editModeEnabled ? '<th class="actions-cell">Actions</th>' : ''}
            </tr>`;

            data.forEach(row => {
                let rowHtml = `
                    <td>${row.date}</td> <td>${row.inspectors}</td> <td>${row.buyer}</td>
                    <td>${row.style}</td> <td>${row.color}</td> <td>${row.lotNo}</td>
                    <td>${row.cuttingNo}</td> <td>${row.totalPieces || 0}</td> <td>${row.totalChecked}</td>
                `;
                
                REJECT_CATEGORIES.forEach(cat => rowHtml += `<td>${row.rejectTotals[cat] || 0}</td>`);
                DEFECT_CATEGORIES.forEach(cat => rowHtml += `<td>${row.defectTotals[cat] || 0}</td>`);
                
                rowHtml += `
                    <td>${row.totalReject}</td> <td>${row.totalDefect}</td> <td>${row.totalReject + row.totalDefect}</td>
                    <td class="${row.fabricDHU > 5 ? 'dhu-fail' : 'dhu-pass'}">${row.fabricDHU}%</td>
                    <td class="${row.cuttingDHU > 2 ? 'dhu-fail' : 'dhu-pass'}">${row.cuttingDHU}%</td>
                    <td class="${row.totalDHU > 7 ? 'dhu-fail' : 'dhu-pass'}">${row.totalDHU}%</td>
                `;
                
                // --- MODIFICATION HERE: Added Edit Button ---
                if (editModeEnabled) {
                    rowHtml += `<td class="actions-cell" style="display: flex; gap: 5px;">
                        <button class="btn btn-warning edit-entries" data-id="${row.id}" style="padding: 5px 10px; font-size: 0.8rem;" title="Edit inspection entries for this cutting">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="btn btn-danger delete-cutting" data-id="${row.id}" style="padding: 5px 10px; font-size: 0.8rem;" title="Delete this entire cutting and its inspections">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>`;
                }
                body.innerHTML += `<tr>${rowHtml}</tr>`;
            });

            // --- ADD EVENT LISTENERS FOR NEW BUTTONS ---
            if (editModeEnabled) {
                // Edit button listener
                document.querySelectorAll('.edit-entries').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cuttingId = this.getAttribute('data-id');
                        openEditModal(cuttingId);
                    });
                });
                
                // Delete button listener (existing)
                document.querySelectorAll('.delete-cutting').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const cuttingId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this cutting plan AND all its inspection entries? This action cannot be undone.')) {
                            try {
                                const related = allInspectionEntries.filter(i => i.cuttingReportId === cuttingId);
                                for (const inspection of related) {
                                    await deleteData(INSPECTION_COLLECTION, inspection.id);
                                }
                                await deleteData(CUTTING_COLLECTION, cuttingId);
                                
                                allCuttingReports = allCuttingReports.filter(r => r.id !== cuttingId);
                                allInspectionEntries = allInspectionEntries.filter(i => i.cuttingReportId !== cuttingId);

                                showToast('Cutting plan and all related inspections deleted!', 'success');
                                document.getElementById('apply-filter-btn').click();
                                populateCuttingSelector();
                                updateTotalBalanceDisplay();
                            } catch (error) {
                                showToast('Error deleting data!', 'error');
                            }
                        }
                    });
                });
            }

             const footerTotals = {
                totalPlan: data.reduce((s, r) => s + (r.totalPieces || 0), 0),
                totalChecked: data.reduce((s, r) => s + r.totalChecked, 0),
                rejects: {}, defects: {},
                totalReject: data.reduce((s, r) => s + r.totalReject, 0),
                totalDefect: data.reduce((s, r) => s + r.totalDefect, 0),
            };
            REJECT_CATEGORIES.forEach(c => footerTotals.rejects[c] = data.reduce((s,r) => s + (r.rejectTotals[c] || 0), 0));
            DEFECT_CATEGORIES.forEach(c => footerTotals.defects[c] = data.reduce((s,r) => s + (r.defectTotals[c] || 0), 0));
            
            let footerHtml = `<td colspan="7"><strong>Grand Total</strong></td>
                <td><strong>${footerTotals.totalPlan}</strong></td>
                <td><strong>${footerTotals.totalChecked}</strong></td>`;
            
            REJECT_CATEGORIES.forEach(c => footerHtml += `<td><strong>${footerTotals.rejects[c]}</strong></td>`);
            DEFECT_CATEGORIES.forEach(c => footerHtml += `<td><strong>${footerTotals.defects[c]}</strong></td>`);
            
            const f_fabricDHU = footerTotals.totalChecked > 0 ? ((footerTotals.totalReject / footerTotals.totalChecked) * 100).toFixed(2) : '0.00';
            const f_cuttingDHU = footerTotals.totalChecked > 0 ? ((footerTotals.totalDefect / footerTotals.totalChecked) * 100).toFixed(2) : '0.00';
            const f_totalDHU = footerTotals.totalChecked > 0 ? (((footerTotals.totalReject + footerTotals.totalDefect) / footerTotals.totalChecked) * 100).toFixed(2) : '0.00';

            footerHtml += `
                <td><strong>${footerTotals.totalReject}</strong></td>
                <td><strong>${footerTotals.totalDefect}</strong></td>
                <td><strong>${footerTotals.totalReject + footerTotals.totalDefect}</strong></td>
                <td><strong>${f_fabricDHU}%</strong></td>
                <td><strong>${f_cuttingDHU}%</strong></td>
                <td><strong>${f_totalDHU}%</strong></td>
                ${editModeEnabled ? '<td></td>' : ''}
            `;
            foot.innerHTML = `<tr>${footerHtml}</tr>`;
        }
        
        // --- NEW EDIT MODAL LOGIC (MODIFIED) ---
        const editModal = document.getElementById('edit-entries-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');

        function openEditModal(cuttingId, entryIds = null) {
            const cuttingReport = allCuttingReports.find(c => c.id === cuttingId);
            let entries = allInspectionEntries.filter(e => e.cuttingReportId === cuttingId);

            // If a specific list of entry IDs is provided, filter further
            if (entryIds) {
                entries = entries.filter(e => entryIds.includes(e.id));
            }

            document.getElementById('edit-modal-header-info').innerHTML = `
                <p><strong>Style:</strong> ${cuttingReport.style} | <strong>Color:</strong> ${cuttingReport.color} | <strong>Lot/Cut No:</strong> ${cuttingReport.lotNo} / ${cuttingReport.cuttingNo}</p>
            `;

            const head = document.getElementById('edit-entries-table-head');
            const body = document.getElementById('edit-entries-table-body');
            
            const headers = ['Date', 'Hour', 'Inspector', 'Checked Qty', ...ALL_DEFECTS, 'Actions'];
            head.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            body.innerHTML = '';
            entries.forEach(entry => {
                let rowHtml = `
                    <td>${entry.date}</td>
                    <td>${entry.inspectionHour || 'N/A'}</td>
                    <td>${entry.inspectorName}</td>
                    <td><input type="number" class="edit-input" data-field="checkedQty" value="${entry.checkedQty || 0}"></td>
                `;
                ALL_DEFECTS.forEach(defect => {
                    const defectValue = (entry.defects && entry.defects[defect]) || 0;
                    rowHtml += `<td><input type="number" class="edit-input" data-field="defects" data-defect-name="${defect}" value="${defectValue}"></td>`;
                });

                rowHtml += `
                    <td style="display: flex; gap: 5px;">
                        <button class="btn btn-success save-entry-change" data-entry-id="${entry.id}"><i class="fas fa-save"></i></button>
                        <button class="btn btn-danger delete-single-entry" data-entry-id="${entry.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                body.innerHTML += `<tr data-row-id="${entry.id}">${rowHtml}</tr>`;
            });

            editModal.style.display = 'flex';
        }

        editModal.addEventListener('click', async function(e) {
            // Save Button Logic
            if (e.target.closest('.save-entry-change')) {
                const btn = e.target.closest('.save-entry-change');
                const entryId = btn.dataset.entryId;
                const row = document.querySelector(`tr[data-row-id="${entryId}"]`);
                
                const updatedData = { defects: {} };

                row.querySelectorAll('.edit-input').forEach(input => {
                    const field = input.dataset.field;
                    const value = parseInt(input.value) || 0;

                    if (field === 'checkedQty') {
                        updatedData.checkedQty = value;
                    } else if (field === 'defects') {
                        const defectName = input.dataset.defectName;
                        if (value > 0) {
                            updatedData.defects[defectName] = value;
                        }
                    }
                });

                try {
                    await updateData(INSPECTION_COLLECTION, entryId, updatedData);
                    
                    // Update local state
                    const entryIndex = allInspectionEntries.findIndex(e => e.id === entryId);
                    if (entryIndex > -1) {
                        allInspectionEntries[entryIndex] = { ...allInspectionEntries[entryIndex], ...updatedData };
                    }

                    showToast('Entry updated successfully!', 'success');
                    document.getElementById('apply-filter-btn').click(); // Refresh main table
                    renderSummaryReport(); // Refresh summary table as well
                } catch (error) {
                    showToast('Failed to update entry!', 'error');
                }
            }

            // Delete Single Entry Logic
            if (e.target.closest('.delete-single-entry')) {
                const btn = e.target.closest('.delete-single-entry');
                const entryId = btn.dataset.entryId;

                if (confirm('Are you sure you want to delete this specific inspection entry?')) {
                    try {
                        await deleteData(INSPECTION_COLLECTION, entryId);
                        
                        // Update local state
                        allInspectionEntries = allInspectionEntries.filter(e => e.id !== entryId);
                        
                        document.querySelector(`#edit-entries-table tr[data-row-id="${entryId}"]`).remove();
                        
                        showToast('Entry deleted!', 'success');
                        document.getElementById('apply-filter-btn').click(); // Refresh main table
                        renderSummaryReport(); // Refresh summary table as well
                    } catch (error) {
                        showToast('Failed to delete entry!', 'error');
                    }
                }
            }
        });
        
        closeEditModalBtn.addEventListener('click', () => { editModal.style.display = 'none'; });
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.style.display = 'none';
            }
        });

        // --- PAGE 4: SUMMARY REPORT (MODIFIED FOR EDIT/DELETE) ---
        function renderSummaryReport() {
            const dateFrom = document.getElementById('summary-filter-date-from').value;
            const dateTo = document.getElementById('summary-filter-date-to').value;
            const inspector = document.getElementById('summary-filter-inspector').value.toLowerCase();
            const buyer = document.getElementById('summary-filter-buyer').value;
            const style = document.getElementById('summary-filter-style').value.toLowerCase();
            const cutNo = document.getElementById('summary-filter-cut-no').value.toLowerCase();

            const filteredData = allInspectionEntries.filter(entry => {
                const cuttingInfo = allCuttingReports.find(c => c.id === entry.cuttingReportId) || {};
                
                const entryDate = new Date(entry.date);
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo) : null;
                if (toDate) toDate.setHours(23, 59, 59, 999);
                if (fromDate && entryDate < fromDate) return false;
                if (toDate && entryDate > toDate) return false;

                if (inspector && !entry.inspectorName.toLowerCase().includes(inspector)) return false;
                if (buyer && cuttingInfo.buyer !== buyer) return false;
                if (style && !(cuttingInfo.style || '').toLowerCase().includes(style)) return false;
                if (cutNo && !(cuttingInfo.cuttingNo || '').toLowerCase().includes(cutNo)) return false;
                
                return true;
            });

            const head = document.getElementById('summary-head');
            const body = document.getElementById('summary-body');
            const foot = document.getElementById('summary-foot');
            
            let headers = ['Date', 'Hour', 'Inspector', 'Buyer', 'Style', 'Color', 'Cut No', 'Checked Qty', 'Total Reject', 'Total Defect'];
            if (editModeEnabled) {
                headers.push('Actions');
            }
            head.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            body.innerHTML = ''; foot.innerHTML = '';
            
            if(filteredData.length === 0) {
                 body.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center;">No inspection data matches the current filters.</td></tr>`;
                 return;
            }
            
            const groupedByHour = {};
            filteredData.forEach(entry => {
                const hour = entry.inspectionHour || 'N/A';
                const key = `${entry.date}-${hour}-${entry.inspectorName}-${entry.cuttingReportId}`;
                if (!groupedByHour[key]) {
                    const cuttingInfo = allCuttingReports.find(c => c.id === entry.cuttingReportId) || {};
                    groupedByHour[key] = {
                        date: entry.date,
                        hour: hour,
                        inspectorName: entry.inspectorName,
                        cuttingInfo: cuttingInfo,
                        checkedQty: 0,
                        totalReject: 0,
                        totalDefect: 0,
                        entryIds: [] // Store original entry IDs
                    };
                }
                groupedByHour[key].checkedQty += entry.checkedQty;
                groupedByHour[key].totalReject += REJECT_CATEGORIES.reduce((sum, cat) => sum + (entry.defects[cat] || 0), 0);
                groupedByHour[key].totalDefect += DEFECT_CATEGORIES.reduce((sum, cat) => sum + (entry.defects[cat] || 0), 0);
                groupedByHour[key].entryIds.push(entry.id);
            });

            Object.values(groupedByHour).sort((a,b) => b.hour - a.hour).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(group => {
                 let rowHtml = `
                    <td>${group.date}</td>
                    <td>${group.hour !== 'N/A' ? `Hour ${group.hour}`: 'N/A'}</td>
                    <td>${group.inspectorName}</td>
                    <td>${group.cuttingInfo.buyer || 'N/A'}</td>
                    <td>${group.cuttingInfo.style || 'N/A'}</td>
                    <td>${group.cuttingInfo.color || 'N/A'}</td>
                    <td>${group.cuttingInfo.cuttingNo || 'N/A'}</td>
                    <td>${group.checkedQty}</td>
                    <td>${group.totalReject}</td>
                    <td>${group.totalDefect}</td>
                `;
                if (editModeEnabled) {
                    rowHtml += `<td class="actions-cell" style="display: flex; gap: 5px; justify-content: center;">
                        <button class="btn btn-warning summary-edit-entries" data-cutting-id="${group.cuttingInfo.id}" data-entry-ids="${group.entryIds.join(',')}" style="padding: 5px 10px; font-size: 0.8rem;" title="Edit these entries">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="btn btn-danger summary-delete-entries" data-entry-ids="${group.entryIds.join(',')}" style="padding: 5px 10px; font-size: 0.8rem;" title="Delete these entries">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>`;
                }
                body.innerHTML += `<tr>${rowHtml}</tr>`;
            });

             const totalChecked = filteredData.reduce((s, e) => s + e.checkedQty, 0);
             const grandTotalReject = filteredData.reduce((s, e) => s + REJECT_CATEGORIES.reduce((s2, cat) => s2 + (e.defects[cat] || 0), 0), 0);
             const grandTotalDefect = filteredData.reduce((s, e) => s + DEFECT_CATEGORIES.reduce((s2, cat) => s2 + (e.defects[cat] || 0), 0), 0);
             
             let footerHtml = `
                <td colspan="7"><strong>Grand Total</strong></td>
                <td><strong>${totalChecked}</strong></td>
                <td><strong>${grandTotalReject}</strong></td>
                <td><strong>${grandTotalDefect}</strong></td>
             `;
             if (editModeEnabled) {
                 footerHtml += '<td></td>';
             }
             foot.innerHTML = `<tr>${footerHtml}</tr>`;
        }

        // --- NEW EVENT LISTENERS FOR SUMMARY PAGE ACTIONS ---
        document.getElementById('summary-report-page').addEventListener('click', async function(e) {
            const editBtn = e.target.closest('.summary-edit-entries');
            if (editBtn) {
                const cuttingId = editBtn.dataset.cuttingId;
                const entryIds = editBtn.dataset.entryIds.split(',');
                openEditModal(cuttingId, entryIds);
                return;
            }

            const deleteBtn = e.target.closest('.summary-delete-entries');
            if (deleteBtn) {
                const entryIds = deleteBtn.dataset.entryIds.split(',');
                if (confirm(`Are you sure you want to delete ${entryIds.length} inspection entry/entries? This action cannot be undone.`)) {
                    try {
                        for (const id of entryIds) {
                            await deleteData(INSPECTION_COLLECTION, id);
                        }
                        allInspectionEntries = allInspectionEntries.filter(e => !entryIds.includes(e.id));
                        showToast(`${entryIds.length} entry/entries deleted successfully!`, 'success');
                        renderSummaryReport();
                        if (pages.adminReport.classList.contains('active')) {
                           document.getElementById('apply-filter-btn').click();
                        }
                    } catch (error) {
                        showToast('Failed to delete entries!', 'error');
                    }
                }
            }
        });


        // --- NAVIGATION HANDLERS ---
        navButtons.newInspection.addEventListener('click', () => {
            document.querySelector('#print-header h4').textContent = 'Cut Panel Inspection Report';
            showPage('newInspection');
            setActiveNav(navButtons.newInspection);
        });

        navButtons.adminReport.addEventListener('click', () => {
            const password = prompt("Please enter the admin password (1):");
            if (password === "9988") {
                document.querySelector('#print-header h4').textContent = 'Cut Panel Inspection Report';
                showPage('adminReport');
                setActiveNav(navButtons.adminReport);
                document.getElementById('apply-filter-btn').click();
            } else if (password !== null) {
                alert("Incorrect password.");
            }
        });

        navButtons.summaryReport.addEventListener('click', () => {
             document.querySelector('#print-header h4').textContent = 'Hourly Summary Report';
             showPage('summaryReport');
             setActiveNav(navButtons.summaryReport);
             renderSummaryReport();
        });
        
         navButtons.editMode.addEventListener('click', function() {
            const password = prompt("Please enter the password to enable edit mode (2):");
             if (password === "9900") {
                editModeEnabled = !editModeEnabled;
                this.classList.toggle('active');
                this.innerHTML = editModeEnabled ? 
                    '<i class="fas fa-toggle-on"></i> Edit Mode ON' : 
                    '<i class="fas fa-edit"></i> Enable Edit';
                if(pages.adminReport.classList.contains('active')) {
                    document.getElementById('apply-filter-btn').click();
                }
                if(pages.summaryReport.classList.contains('active')) {
                    renderSummaryReport();
                }
            } else if (password !== null) {
                alert("Incorrect password.");
            }
        });
        
        // --- REPORT ACTIONS ---
        document.getElementById('print-report-btn').addEventListener('click', () => window.print());
        document.getElementById('download-excel-btn').addEventListener('click', () => {
             const table = document.getElementById('report-table');
             let csv = [];
             table.querySelectorAll("tr").forEach(row => {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                const colLength = editModeEnabled ? cols.length - 1 : cols.length;
                for (let i = 0; i < colLength; i++) {
                     let data = cols[i].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                     if (data.includes(',')) data = `"${data}"`;
                     rowData.push(data);
                }
                csv.push(rowData.join(","));
             });
             
             const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
             const link = document.createElement("a");
             link.setAttribute("href", encodeURI(csvContent));
             link.setAttribute("download", `cut_panel_inspection_report_${new Date().toISOString().slice(0,10)}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        });

        document.getElementById('summary-apply-filter-btn').addEventListener('click', renderSummaryReport);
        document.getElementById('summary-print-report-btn').addEventListener('click', () => window.print());
        document.getElementById('summary-download-excel-btn').addEventListener('click', () => {
             const table = document.getElementById('summary-table');
             let csv = [];
             table.querySelectorAll("tr").forEach(row => {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                const colLength = editModeEnabled ? cols.length - 1 : cols.length;
                for (let i = 0; i < colLength; i++) {
                     let data = cols[i].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                     if (data.includes(',')) data = `"${data}"`;
                     rowData.push(data);
                }
                csv.push(rowData.join(","));
             });
             
             const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
             const link = document.createElement("a");
             link.setAttribute("href", encodeURI(csvContent));
             link.setAttribute("download", `hourly_summary_report_${new Date().toISOString().slice(0,10)}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        });


        // --- START THE APP ---
        const firebaseCheck = setInterval(() => {
            if (window.firebaseDb && window.firebaseFunctions) {
                clearInterval(firebaseCheck);
                initialize();
            }
        }, 100);
    });
    </script>
</body>
</html>