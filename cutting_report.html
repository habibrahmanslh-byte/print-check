<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutting Plan Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYGvVO1xCKRWpYeBgYeJcst91cFV9VbEw",
            authDomain: "cut-panel-inspection.firebaseapp.com",
            projectId: "cut-panel-inspection",
            storageBucket: "cut-panel-inspection.firebasestorage.app",
            messagingSenderId: "715452565109",
            appId: "1:715452565109:web:9b418d023a8f41d0239a3c",
            measurementId: "G-PVL6NKWQYH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy
        };
    </script>

    <style>
        /* Modern Color Scheme & Variables */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-accent: linear-gradient(135deg, #f72585, #b5179e);
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        header {
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-container img {
            height: 50px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }

        .logo-container h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
        }

        /* Navigation */
        nav ul {
            display: flex;
            list-style: none;
            gap: 10px;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
        }

        nav ul li button {
            background: transparent;
            border: 2px solid transparent;
            color: var(--dark);
            font-weight: 600;
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav ul li button:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        nav ul li button.active {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* Card Container */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            max-width: 700px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            background: var(--gradient);
            color: var(--white);
            padding: 20px 30px;
            position: relative;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h2 i {
            font-size: 1.3rem;
        }

        .card-body {
            padding: 30px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        .btn-primary {
            background: var(--gradient);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--gray);
            color: var(--white);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        /* Size/Ratio Section */
        .size-ratio-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-light);
        }

        .size-ratio-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .size-ratio-row .form-control {
            flex: 1;
        }

        .remove-size-btn {
            width: 42px;
            height: 42px;
            background: var(--danger);
            color: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .remove-size-btn:hover {
            background: #c1121f;
            transform: scale(1.05);
        }

        .add-size-btn {
            width: 100%;
            margin-top: 10px;
        }

        /* Page Display Logic */
        .page {
            display: none;
            width: 100%;
        }

        .page.active {
            display: flex;
            justify-content: center;
        }

        /* Report Page */
        .report-container {
            width: 100%;
            max-width: 95%;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .report-header {
            background: var(--gradient);
            color: var(--white);
            padding: 20px 30px;
        }

        .report-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid var(--gray-light);
        }

        .filter-section .form-control {
            margin-bottom: 0;
        }

        .filter-section .btn {
            grid-column: 1 / -1;
            width: auto;
            justify-self: start;
            margin-top: 5px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            padding: 0 20px 20px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 1000px;
            border: 1px solid var(--gray-light); /* Added border to the whole table */
        }

        .report-table th {
            background: var(--primary);
            color: var(--white);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
            border: 1px solid var(--gray-light); /* Added border to header cells */
        }

        .report-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--gray-light);
            white-space: nowrap;
            border: 1px solid var(--gray-light); /* Added border to data cells */
        }

        .report-table tbody tr {
            transition: var(--transition);
        }

        .report-table tbody tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .report-table tbody tr:nth-child(even) {
            background: rgba(248, 249, 250, 0.7);
        }

        .report-table tbody tr:nth-child(even):hover {
            background: rgba(67, 97, 238, 0.08);
        }

        .report-table tfoot {
            font-weight: bold;
            background: var(--light);
        }

        .report-table tfoot td {
            padding: 16px 12px;
        }

        /* Edit Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: var(--gradient);
            color: var(--white);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }

            .logo-container {
                justify-content: center;
            }

            nav ul {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            main {
                padding: 20px 15px;
            }

            .card-body {
                padding: 20px;
            }

            .filter-section {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .size-ratio-row {
                flex-direction: column;
                gap: 10px;
            }

            .remove-size-btn {
                width: 100%;
                height: 46px;
            }

            .modal-content {
                max-height: 95vh;
            }
        }

        @media (max-width: 576px) {
            .logo-container h1 {
                font-size: 1.5rem;
            }

            nav ul li button {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .card-header, .report-header, .modal-header {
                padding: 15px 20px;
            }

            .card-header h2, .report-header h2, .modal-header h2 {
                font-size: 1.3rem;
            }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-on {
            background: rgba(76, 201, 240, 0.15);
            color: var(--success);
        }

        .status-off {
            background: rgba(108, 117, 125, 0.15);
            color: var(--gray);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .progress-steps:before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gray-light);
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-light);
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-weight: bold;
            transition: var(--transition);
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
        }

        .progress-step.active .step-icon {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        .progress-step.active .step-label {
            color: var(--primary);
        }

        .progress-step.completed .step-icon {
            background: var(--success);
            color: var(--white);
        }

        .progress-step.completed .step-label {
            color: var(--success);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--dark);
            color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.postimg.cc/pX0b4dM3/20251017-203816.png" alt="Logo">
            <h1>Cutting Report</h1>
        </div>
        <nav>
            <ul>
                <li><button id="nav-new-report"><i class="fas fa-plus-circle"></i> Create New Report</button></li>
                <li><button id="nav-today-report"><i class="fas fa-calendar-day"></i> Today's Report</button></li>
                <li><button id="nav-all-report"><i class="fas fa-list"></i> All Reports</button></li>
                <li><button id="nav-edit-mode"><i class="fas fa-edit"></i> Enable Edit/Delete</button></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Page 1: Main Details -->
        <section id="page1" class="page active">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-clipboard-list"></i> Step 1: Main Details</h2>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="progress-step active">
                            <div class="step-icon">1</div>
                            <div class="step-label">Main Details</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">2</div>
                            <div class="step-label">Cutting Details</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">3</div>
                            <div class="step-label">Size & Ratio</div>
                        </div>
                    </div>
                    <form id="form1">
                        <div class="form-group">
                            <label for="date" class="form-label"><i class="fas fa-calendar-alt"></i> Date</label>
                            <input type="date" id="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="buyer" class="form-label"><i class="fas fa-user-tag"></i> Buyer</label>
                            <select id="buyer" name="buyer" class="form-control" required>
                                <option value="">Select Buyer</option>
                                <option>Puma</option>
                                <option>M&S</option>
                                <option>Lahalle</option>
                                <option>Seiden sticker</option>
                                <option>Pepco</option>
                                <option>Sanmar canada</option>
                                <option>Silksilk</option>
                                <option>H&M</option>
                                <option>Soliver</option>
                                <option>Juritex</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="style" class="form-label"><i class="fas fa-tshirt"></i> Style</label>
                            <input type="text" id="style" name="style" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="color" class="form-label"><i class="fas fa-palette"></i> Color</label>
                            <input type="text" id="color" name="color" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="item" class="form-label"><i class="fas fa-box"></i> Item</label>
                            <select id="item" name="item" class="form-control" required>
                                <option value="">Select Item</option>
                                <option>T-Shirt</option>
                                <option>Polo shirt</option>
                                <option>Tank top</option>
                                <option>Pant</option>
                                <option>Jacket</option>
                                <option>Tawser</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tableNo" class="form-label"><i class="fas fa-table"></i> Table No</label>
                            <select id="tableNo" name="tableNo" class="form-control" required>
                                <option value="">Select Table No</option>
                                <option>01</option>
                                <option>02</option>
                                <option>03</option>
                                <option>04</option>
                                <option>05</option>
                                <option>06</option>
                                <option>07</option>
                                <option>08</option>
                                <option>09</option>
                                <option>10</option>
                                <option>11</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aqcName" class="form-label"><i class="fas fa-user-check"></i> AQC Name</label>
                            <input type="text" id="aqcName" name="aqcName" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Submit & Next</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Page 2: Cutting Details -->
        <section id="page2" class="page">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-cut"></i> Step 2: Lot & Cutting Details</h2>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="progress-step completed">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <div class="step-label">Main Details</div>
                        </div>
                        <div class="progress-step active">
                            <div class="step-icon">2</div>
                            <div class="step-label">Cutting Details</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">3</div>
                            <div class="step-label">Size & Ratio</div>
                        </div>
                    </div>
                    <form id="form2">
                        <div class="form-group">
                            <label for="lotNo" class="form-label"><i class="fas fa-barcode"></i> Lot No</label>
                            <input type="text" id="lotNo" name="lotNo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="cuttingNo" class="form-label"><i class="fas fa-scissors"></i> Cutting No</label>
                            <input type="text" id="cuttingNo" name="cuttingNo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="layQty" class="form-label"><i class="fas fa-layer-group"></i> Lay Qty</label>
                            <input type="number" id="layQty" name="layQty" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="gradingLay" class="form-label"><i class="fas fa-ruler-combined"></i> Grading Lay (Optional)</label>
                            <input type="number" id="gradingLay" name="gradingLay" class="form-control" placeholder="e.g., 5">
                        </div>
                        <div class="form-group">
                            <label for="gradingSize" class="form-label"><i class="fas fa-expand-alt"></i> Grading Size (Optional)</label>
                            <input type="text" id="gradingSize" name="gradingSize" class="form-control" placeholder="e.g., M">
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Submit & Next</button>
                        <div class="btn-group">
                            <button type="button" id="backToPage1" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Main Details</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Page 3: Size & Ratio -->
        <section id="page3" class="page">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-ruler-horizontal"></i> Step 3: Size & Ratio Details</h2>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="progress-step completed">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <div class="step-label">Main Details</div>
                        </div>
                        <div class="progress-step completed">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <div class="step-label">Cutting Details</div>
                        </div>
                        <div class="progress-step active">
                            <div class="step-icon">3</div>
                            <div class="step-label">Size & Ratio</div>
                        </div>
                    </div>
                    <form id="form3">
                        <div id="size-ratio-container" class="size-ratio-container">
                            <div class="size-ratio-row">
                                <input type="text" name="size" class="form-control" placeholder="Size (e.g., M or 42)" required>
                                <input type="number" name="ratio" class="form-control" placeholder="Ratio (e.g., 2)" required>
                                <button type="button" class="remove-size-btn" style="display:none;"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" id="add-size-btn" class="btn btn-secondary add-size-btn"><i class="fas fa-plus"></i> Add More Size</button>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="remarks" class="form-label"><i class="fas fa-comment-alt"></i> Remarks (Optional)</label>
                            <input type="text" id="remarks" name="remarks" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-file-alt"></i> Create Report</button>
                        <div class="btn-group">
                            <button type="button" id="backToPage2" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Cutting Details</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- Report Page -->
        <section id="report-page" class="page">
            <div class="report-container">
                <div class="report-header">
                    <h2><i class="fas fa-chart-bar"></i> Cutting Reports</h2>
                </div>
                <div class="filter-section">
                    <input type="date" id="filter-date-from" class="form-control" title="Date From">
                    <input type="date" id="filter-date-to" class="form-control" title="Date To">
                    <select id="filter-buyer" class="form-control">
                        <option value="">All Buyers</option>
                        <option>Puma</option>
                        <option>M&S</option>
                        <option>Lahalle</option>
                        <option>Seiden sticker</option>
                        <option>Pepco</option>
                        <option>Sanmar canada</option>
                        <option>Silksilk</option>
                        <option>H&M</option>
                        <option>Soliver</option>
                        <option>Juritex</option>
                    </select>
                    <input type="text" id="filter-style" class="form-control" placeholder="Filter by Style">
                    <input type="text" id="filter-color" class="form-control" placeholder="Filter by Color">
                    <input type="text" id="filter-lot" class="form-control" placeholder="Filter by Lot No">
                    <input type="text" id="filter-cutting" class="form-control" placeholder="Filter by Cutting No">
                    <button id="apply-filter-btn" class="btn btn-primary"><i class="fas fa-filter"></i> Apply Filters</button>
                </div>
                <div class="table-container">
                    <table id="report-table" class="report-table">
                        <thead id="report-head"></thead>
                        <tbody id="report-body"></tbody>
                        <tfoot id="report-foot"></tfoot>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Edit Report Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Report Details</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label for="edit-date" class="form-label"><i class="fas fa-calendar-alt"></i> Date</label>
                        <input type="date" id="edit-date" name="date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-buyer" class="form-label"><i class="fas fa-user-tag"></i> Buyer</label>
                        <select id="edit-buyer" name="buyer" class="form-control" required>
                            <option value="">Select Buyer</option>
                            <option>Puma</option>
                            <option>M&S</option>
                            <option>Lahalle</option>
                            <option>Seiden sticker</option>
                            <option>Pepco</option>
                            <option>Sanmar canada</option>
                            <option>Silksilk</option>
                            <option>H&M</option>
                            <option>Soliver</option>
                            <option>Juritex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-style" class="form-label"><i class="fas fa-tshirt"></i> Style</label>
                        <input type="text" id="edit-style" name="style" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-color" class="form-label"><i class="fas fa-palette"></i> Color</label>
                        <input type="text" id="edit-color" name="color" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-item" class="form-label"><i class="fas fa-box"></i> Item</label>
                        <select id="edit-item" name="item" class="form-control" required>
                            <option value="">Select Item</option>
                            <option>T-Shirt</option>
                            <option>Polo shirt</option>
                            <option>Tank top</option>
                            <option>Pant</option>
                            <option>Jacket</option>
                            <option>Tawser</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-tableNo" class="form-label"><i class="fas fa-table"></i> Table No</label>
                        <select id="edit-tableNo" name="tableNo" class="form-control" required>
                             <option value="">Select Table No</option>
                                <option>01</option>
                                <option>02</option>
                                <option>03</option>
                                <option>04</option>
                                <option>05</option>
                                <option>06</option>
                                <option>07</option>
                                <option>08</option>
                                <option>09</option>
                                <option>10</option>
                                <option>11</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-aqcName" class="form-label"><i class="fas fa-user-check"></i> AQC Name</label>
                        <input type="text" id="edit-aqcName" name="aqcName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-remarks" class="form-label"><i class="fas fa-comment-alt"></i> Remarks</label>
                        <input type="text" id="edit-remarks" name="remarks" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- STATE MANAGEMENT ---
            let reportData = {};
            let allReports = [];
            let editModeEnabled = false;

            // --- PAGE & MODAL ELEMENTS ---
            const pages = { page1: document.getElementById('page1'), page2: document.getElementById('page2'), page3: document.getElementById('page3'), reportPage: document.getElementById('report-page') };
            const editModal = document.getElementById('edit-modal');
            const closeBtn = document.querySelector('.close-btn');
            const toast = document.getElementById('toast');

            // --- FORM ELEMENTS ---
            const forms = { form1: document.getElementById('form1'), form2: document.getElementById('form2'), form3: document.getElementById('form3'), editForm: document.getElementById('edit-form') };

            // --- NAVIGATION ---
            const navButtons = {
                newReport: document.getElementById('nav-new-report'),
                todayReport: document.getElementById('nav-today-report'),
                allReport: document.getElementById('nav-all-report'),
                editMode: document.getElementById('nav-edit-mode'),
                backToPage1: document.getElementById('backToPage1'),
                backToPage2: document.getElementById('backToPage2')
            };
            const navLinks = document.querySelectorAll('nav ul li button');

            // --- DYNAMIC ELEMENTS ---
            const sizeRatioContainer = document.getElementById('size-ratio-container');
            const addSizeBtn = document.getElementById('add-size-btn');

            // --- REPORT & FILTER ELEMENTS ---
            const reportHead = document.getElementById('report-head');
            const reportBody = document.getElementById('report-body');
            const reportFoot = document.getElementById('report-foot');
            const applyFilterBtn = document.getElementById('apply-filter-btn');

            // --- FIREBASE FUNCTIONS ---
            async function saveReportToFirebase(report) {
                try {
                    const docRef = await window.firebaseFunctions.addDoc(
                        window.firebaseFunctions.collection(window.firebaseDb, "cutting reports"), 
                        report
                    );
                    report.id = docRef.id; // Add Firebase document ID
                    return report;
                } catch (error) {
                    console.error("Error adding document: ", error);
                    throw error;
                }
            }

            async function loadReportsFromFirebase() {
                try {
                    const querySnapshot = await window.firebaseFunctions.getDocs(
                        window.firebaseFunctions.collection(window.firebaseDb, "cutting reports")
                    );
                    allReports = [];
                    querySnapshot.forEach((doc) => {
                        allReports.push({ id: doc.id, ...doc.data() });
                    });
                    return allReports;
                } catch (error) {
                    console.error("Error loading documents: ", error);
                    throw error;
                }
            }

            async function updateReportInFirebase(id, updatedData) {
                try {
                    const reportRef = window.firebaseFunctions.doc(window.firebaseDb, "cutting reports", id);
                    await window.firebaseFunctions.updateDoc(reportRef, updatedData);
                    return true;
                } catch (error) {
                    console.error("Error updating document: ", error);
                    throw error;
                }
            }

            async function deleteReportFromFirebase(id) {
                try {
                    await window.firebaseFunctions.deleteDoc(
                        window.firebaseFunctions.doc(window.firebaseDb, "cutting reports", id)
                    );
                    return true;
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    throw error;
                }
            }

            // --- HELPER FUNCTIONS ---
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            function setActiveNav(button) {
                navLinks.forEach(link => link.classList.remove('active'));
                button.classList.add('active');
            }

            function showPage(pageId) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                if (pages[pageId]) pages[pageId].classList.add('active');
                
                // Update progress steps
                const progressSteps = document.querySelectorAll('.progress-step');
                progressSteps.forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                if (pageId === 'page1') {
                    document.querySelectorAll('.progress-step')[0].classList.add('active');
                } else if (pageId === 'page2') {
                    document.querySelectorAll('.progress-step')[0].classList.add('completed');
                    document.querySelectorAll('.progress-step')[1].classList.add('active');
                } else if (pageId === 'page3') {
                    document.querySelectorAll('.progress-step')[0].classList.add('completed');
                    document.querySelectorAll('.progress-step')[1].classList.add('completed');
                    document.querySelectorAll('.progress-step')[2].classList.add('active');
                }
            }

            async function saveDataAndRender() {
                try {
                    applyFilterBtn.click(); // Re-filter and render
                    showToast('Data saved successfully!');
                } catch (error) {
                    showToast('Error saving data!', 'error');
                }
            }

            // --- SIZE RATIO MANAGEMENT ---
            function addSizeRatioRow() {
                const row = document.createElement('div');
                row.className = 'size-ratio-row';
                row.innerHTML = `
                    <input type="text" name="size" class="form-control" placeholder="Size (e.g., M or 42)" required>
                    <input type="number" name="ratio" class="form-control" placeholder="Ratio (e.g., 2)" required>
                    <button type="button" class="remove-size-btn"><i class="fas fa-times"></i></button>
                `;
                sizeRatioContainer.appendChild(row);
                row.querySelector('.remove-size-btn').addEventListener('click', function() {
                    if (sizeRatioContainer.children.length > 1) {
                        row.remove();
                    }
                });
            }

            // --- FORM HANDLERS ---
            forms.form1.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                for (const [key, value] of formData.entries()) {
                    reportData[key] = value;
                }
                showPage('page2');
            });

            forms.form2.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                for (const [key, value] of formData.entries()) {
                    reportData[key] = value;
                }
                showPage('page3');
            });

            forms.form3.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                try {
                    submitBtn.innerHTML = '<div class="loading"></div> Saving...';
                    submitBtn.disabled = true;
                    
                    const formData = new FormData(this);
                    reportData.remarks = formData.get('remarks');
                    
                    // Collect size ratios
                    const sizeRatioRows = document.querySelectorAll('.size-ratio-row');
                    const sizeRatios = [];
                    sizeRatioRows.forEach(row => {
                        const size = row.querySelector('input[name="size"]').value;
                        const ratio = parseInt(row.querySelector('input[name="ratio"]').value);
                        if (size && ratio) sizeRatios.push({ size, ratio });
                    });
                    reportData.sizeRatios = sizeRatios;
                    
                    // Generate unique ID
                    reportData.groupId = Date.now().toString();
                    
                    const totalRatio = sizeRatios.reduce((sum, item) => sum + item.ratio, 0);
                    const layQty = parseInt(reportData.layQty) || 0;
                    const gradingLay = parseInt(reportData.gradingLay) || 0;
                    reportData.totalPieces = (layQty * totalRatio) + gradingLay;
                    
                    // Save to Firebase
                    const savedReport = await saveReportToFirebase(reportData);
                    allReports.push(savedReport);
                    
                    // Reset forms
                    forms.form1.reset();
                    forms.form2.reset();
                    forms.form3.reset();
                    reportData = {};
                    
                    while (sizeRatioContainer.children.length > 1) {
                        sizeRatioContainer.lastChild.remove();
                    }
                    sizeRatioContainer.querySelector('.remove-size-btn').style.display = 'none';
                    
                    showPage('reportPage');
                    setActiveNav(navButtons.allReport);
                    
                } catch (error) {
                    showToast('Error creating report!', 'error');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            // --- NAVIGATION HANDLERS ---
            navButtons.newReport.addEventListener('click', function() {
                showPage('page1');
                setActiveNav(this);
            });

            navButtons.todayReport.addEventListener('click', async function() {
                try {
                    await loadReportsFromFirebase();
                    showPage('reportPage');
                    setActiveNav(this);
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('filter-date-from').value = today;
                    document.getElementById('filter-date-to').value = today;
                    applyFilterBtn.click();
                } catch (error) {
                    showToast('Error loading reports!', 'error');
                }
            });

            navButtons.allReport.addEventListener('click', async function() {
                const password = prompt("Please enter the password to view all reports:");
                if (password === "9988") {
                    try {
                        await loadReportsFromFirebase();
                        showPage('reportPage');
                        setActiveNav(this);
                        document.getElementById('filter-date-from').value = '';
                        document.getElementById('filter-date-to').value = '';
                        applyFilterBtn.click();
                    } catch (error) {
                        showToast('Error loading reports!', 'error');
                    }
                } else if (password !== null) {
                    alert("Incorrect password.");
                }
            });

            navButtons.editMode.addEventListener('click', function() {
                const password = prompt("Please enter the password to enable edit mode:");
                 if (password === "9900") {
                    editModeEnabled = !editModeEnabled;
                    this.classList.toggle('active');
                    this.innerHTML = editModeEnabled ? 
                        '<i class="fas fa-toggle-on"></i> Edit Mode ON' : 
                        '<i class="fas fa-toggle-off"></i> Enable Edit/Delete';
                    applyFilterBtn.click();
                } else if (password !== null) {
                    alert("Incorrect password.");
                }
            });

            navButtons.backToPage1.addEventListener('click', function() {
                showPage('page1');
            });

            navButtons.backToPage2.addEventListener('click', function() {
                showPage('page2');
            });

            // --- FILTER & REPORT GENERATION ---
            applyFilterBtn.addEventListener('click', function() {
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                const buyer = document.getElementById('filter-buyer').value;
                const style = document.getElementById('filter-style').value.toLowerCase();
                const color = document.getElementById('filter-color').value.toLowerCase();
                const lot = document.getElementById('filter-lot').value.toLowerCase();
                const cutting = document.getElementById('filter-cutting').value.toLowerCase();

                const filteredReports = allReports.filter(report => {
                    const reportDate = new Date(report.date);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo) : null;
                    
                    return (!fromDate || reportDate >= fromDate) &&
                           (!toDate || reportDate <= toDate) &&
                           (!buyer || report.buyer === buyer) &&
                           (!style || report.style.toLowerCase().includes(style)) &&
                           (!color || report.color.toLowerCase().includes(color)) &&
                           (!lot || report.lotNo.toLowerCase().includes(lot)) &&
                           (!cutting || report.cuttingNo.toLowerCase().includes(cutting));
                });

                renderReportTable(filteredReports);
            });
            
            // Custom sort function for sizes
            function customSizeSort(a, b) {
                const sizeOrder = {
                    'XXS': 1, 'XS': 2, 'S': 3, 'M': 4, 'L': 5, 'XL': 6, 'XXL': 7, 'XXXL': 8,
                    '2XL': 7, '3XL': 8, '4XL': 9, '5XL': 10
                };

                const aIsNum = !isNaN(parseFloat(a));
                const bIsNum = !isNaN(parseFloat(b));

                if (aIsNum && bIsNum) {
                    return parseFloat(a) - parseFloat(b);
                }

                if (sizeOrder[a.toUpperCase()] && sizeOrder[b.toUpperCase()]) {
                    return sizeOrder[a.toUpperCase()] - sizeOrder[b.toUpperCase()];
                }
                
                if (aIsNum && !bIsNum) return -1; // Numbers first
                if (!aIsNum && bIsNum) return 1;  // Then text sizes

                return a.localeCompare(b); // Fallback for others
            }

            function renderReportTable(reports) {
                reportHead.innerHTML = '';
                reportBody.innerHTML = '';
                reportFoot.innerHTML = '';

                if (reports.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="100" style="text-align: center; padding: 30px;">No reports found</td>`;
                    reportBody.appendChild(row);
                    return;
                }

                const allSizes = new Set();
                reports.forEach(report => {
                    if (report.sizeRatios) {
                        report.sizeRatios.forEach(sr => allSizes.add(sr.size));
                    }
                });
                const sortedSizes = Array.from(allSizes).sort(customSizeSort); // Use custom sort

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
                    <th>Date</th>
                    <th>Buyer</th>
                    <th>Style</th>
                    <th>Color</th>
                    <th>Item</th>
                    <th>Table No</th>
                    <th>AQC Name</th>
                    <th>Lot No</th>
                    <th>Cutting No</th>
                    <th>Lay Qty</th>
                    ${sortedSizes.map(size => `<th>${size}</th>`).join('')}
                    <th>Total</th>
                    <th>Remarks</th>
                    ${editModeEnabled ? '<th>Actions</th>' : ''}
                `;
                reportHead.appendChild(headerRow);

                reports.forEach(report => {
                    const row = document.createElement('tr');
                    const sizeMap = new Map((report.sizeRatios || []).map(sr => [sr.size, sr.ratio]));
                    const layQty = parseInt(report.layQty) || 0;
                    const gradingLay = parseInt(report.gradingLay) || 0;
                    const gradingSize = report.gradingSize || '';

                    row.innerHTML = `
                        <td>${report.date}</td>
                        <td>${report.buyer}</td>
                        <td>${report.style}</td>
                        <td>${report.color}</td>
                        <td>${report.item}</td>
                        <td>${report.tableNo}</td>
                        <td>${report.aqcName}</td>
                        <td>${report.lotNo}</td>
                        <td>${report.cuttingNo}</td>
                        <td>${layQty}</td>
                        ${sortedSizes.map(size => {
                            const ratio = sizeMap.get(size) || 0;
                            let finalQty = layQty * ratio;
                            if (size.toString().toLowerCase() === gradingSize.toString().toLowerCase()) {
                                finalQty += gradingLay;
                            }
                            return `<td>${finalQty}</td>`;
                        }).join('')}
                        <td>${report.totalPieces}</td>
                        <td>${report.remarks || ''}</td>
                        ${editModeEnabled ? `
                            <td>
                                <button class="btn btn-secondary edit-report" data-id="${report.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger delete-report" data-id="${report.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        ` : ''}
                    `;
                    reportBody.appendChild(row);
                });

                const footerRow = document.createElement('tr');
                const totals = {
                    layQty: 0,
                    totalPieces: 0
                };
                sortedSizes.forEach(size => totals[size] = 0);
                
                reports.forEach(report => {
                    const layQty = parseInt(report.layQty) || 0;
                    const gradingLay = parseInt(report.gradingLay) || 0;
                    const gradingSize = report.gradingSize || '';

                    totals.layQty += layQty;
                    totals.totalPieces += parseInt(report.totalPieces) || 0;

                    const sizeMap = new Map((report.sizeRatios || []).map(sr => [sr.size, sr.ratio]));
                    
                    sortedSizes.forEach(size => {
                        const ratio = sizeMap.get(size) || 0;
                        let finalQty = layQty * ratio;
                        if (size.toString().toLowerCase() === gradingSize.toString().toLowerCase()) {
                            finalQty += gradingLay;
                        }
                        totals[size] += finalQty;
                    });
                });

                footerRow.innerHTML = `
                    <td colspan="9"><strong>Total</strong></td>
                    <td><strong>${totals.layQty}</strong></td>
                    ${sortedSizes.map(size => `<td><strong>${totals[size] || 0}</strong></td>`).join('')}
                    <td><strong>${totals.totalPieces}</strong></td>
                    <td colspan="${editModeEnabled ? 2 : 1}"></td>
                `;
                reportFoot.appendChild(footerRow);

                if (editModeEnabled) {
                    document.querySelectorAll('.edit-report').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const report = allReports.find(r => r.id === id);
                            if (report) {
                                openEditModal(report);
                            }
                        });
                    });

                    document.querySelectorAll('.delete-report').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const id = this.getAttribute('data-id');
                            if (confirm('Are you sure you want to delete this report?')) {
                                try {
                                    await deleteReportFromFirebase(id);
                                    allReports = allReports.filter(r => r.id !== id);
                                    saveDataAndRender();
                                    showToast('Report deleted successfully!');
                                } catch (error) {
                                    showToast('Error deleting report!', 'error');
                                }
                            }
                        });
                    });
                }
            }

            // --- EDIT MODAL FUNCTIONS ---
            function openEditModal(report) {
                document.getElementById('edit-id').value = report.id;
                document.getElementById('edit-date').value = report.date;
                document.getElementById('edit-buyer').value = report.buyer;
                document.getElementById('edit-style').value = report.style;
                document.getElementById('edit-color').value = report.color;
                document.getElementById('edit-item').value = report.item;
                document.getElementById('edit-tableNo').value = report.tableNo;
                document.getElementById('edit-aqcName').value = report.aqcName;
                document.getElementById('edit-remarks').value = report.remarks || '';
                
                editModal.classList.add('active');
            }

            forms.editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                try {
                    submitBtn.innerHTML = '<div class="loading"></div> Saving...';
                    submitBtn.disabled = true;
                    
                    const id = document.getElementById('edit-id').value;
                    const formData = new FormData(this);
                    const updatedData = {};
                    
                    for (const [key, value] of formData.entries()) {
                        updatedData[key] = value;
                    }
                    
                    await updateReportInFirebase(id, updatedData);
                    
                    // Update local data
                    const reportIndex = allReports.findIndex(r => r.id === id);
                    if (reportIndex !== -1) {
                        allReports[reportIndex] = { ...allReports[reportIndex], ...updatedData };
                    }
                    
                    saveDataAndRender();
                    editModal.classList.remove('active');
                    showToast('Report updated successfully!');
                    
                } catch (error) {
                    showToast('Error updating report!', 'error');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            closeBtn.addEventListener('click', function() {
                editModal.classList.remove('active');
            });

            window.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    editModal.classList.remove('active');
                }
            });

            // --- INITIALIZATION ---
            function init() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                
                addSizeBtn.addEventListener('click', addSizeRatioRow);
                
                sizeRatioContainer.addEventListener('input', function() {
                    const removeBtns = document.querySelectorAll('.remove-size-btn');
                    removeBtns.forEach(btn => {
                        btn.style.display = sizeRatioContainer.children.length > 1 ? 'flex' : 'none';
                    });
                });
                
                // Load initial data from Firebase
                loadReportsFromFirebase().then(() => {
                    console.log('Initial data loaded from Firebase');
                }).catch(error => {
                    console.error('Error loading initial data:', error);
                });
                
                showPage('page1');
                setActiveNav(navButtons.newReport);
            }

            // Wait for Firebase to be ready
            const checkFirebaseReady = setInterval(() => {
                if (window.firebaseDb) {
                    clearInterval(checkFirebaseReady);
                    init();
                }
            }, 100);
        });
    </script>
</body>
</html>